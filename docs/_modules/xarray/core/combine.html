

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xarray.core.combine &mdash; De:code 0.4 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="De:code 0.4 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> De:code
          

          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">De:code</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>xarray.core.combine</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xarray.core.combine</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.alignment</span> <span class="k">import</span> <span class="n">align</span>
<span class="kn">from</span> <span class="nn">.merge</span> <span class="k">import</span> <span class="n">merge</span>
<span class="kn">from</span> <span class="nn">.pycompat</span> <span class="k">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">basestring</span>
<span class="kn">from</span> <span class="nn">.variable</span> <span class="k">import</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">as_variable</span><span class="p">,</span> <span class="n">IndexVariable</span><span class="p">,</span> <span class="n">concat</span> <span class="k">as</span> <span class="n">concat_vars</span>


<div class="viewcode-block" id="concat"><a class="viewcode-back" href="../../../apis/decode.html#decode.concat">[docs]</a><span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="n">objs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_vars</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="s1">&#39;different&#39;</span><span class="p">,</span>
           <span class="n">compat</span><span class="o">=</span><span class="s1">&#39;equals&#39;</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indexers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">concat_over</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Concatenate xarray objects along a new or existing dimension.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objs : sequence of Dataset and DataArray objects</span>
<span class="sd">        xarray objects to concatenate together. Each object is expected to</span>
<span class="sd">        consist of variables and coordinates with matching shapes except for</span>
<span class="sd">        along the concatenated dimension.</span>
<span class="sd">    dim : str or DataArray or pandas.Index</span>
<span class="sd">        Name of the dimension to concatenate along. This can either be a new</span>
<span class="sd">        dimension name, in which case it is added along axis=0, or an existing</span>
<span class="sd">        dimension name, in which case the location of the dimension is</span>
<span class="sd">        unchanged. If dimension is provided as a DataArray or Index, its name</span>
<span class="sd">        is used as the dimension to concatenate along and the values are added</span>
<span class="sd">        as a coordinate.</span>
<span class="sd">    data_vars : {&#39;minimal&#39;, &#39;different&#39;, &#39;all&#39; or list of str}, optional</span>
<span class="sd">        These data variables will be concatenated together:</span>
<span class="sd">          * &#39;minimal&#39;: Only data variables in which the dimension already</span>
<span class="sd">            appears are included.</span>
<span class="sd">          * &#39;different&#39;: Data variables which are not equal (ignoring</span>
<span class="sd">            attributes) across all datasets are also concatenated (as well as</span>
<span class="sd">            all for which dimension already appears). Beware: this option may</span>
<span class="sd">            load the data payload of data variables into memory if they are not</span>
<span class="sd">            already loaded.</span>
<span class="sd">          * &#39;all&#39;: All data variables will be concatenated.</span>
<span class="sd">          * list of str: The listed data variables will be concatenated, in</span>
<span class="sd">            addition to the &#39;minimal&#39; data variables.</span>
<span class="sd">        If objects are DataArrays, data_vars must be &#39;all&#39;.</span>
<span class="sd">    coords : {&#39;minimal&#39;, &#39;different&#39;, &#39;all&#39; o list of str}, optional</span>
<span class="sd">        These coordinate variables will be concatenated together:</span>
<span class="sd">          * &#39;minimal&#39;: Only coordinates in which the dimension already appears</span>
<span class="sd">            are included.</span>
<span class="sd">          * &#39;different&#39;: Coordinates which are not equal (ignoring attributes)</span>
<span class="sd">            across all datasets are also concatenated (as well as all for which</span>
<span class="sd">            dimension already appears). Beware: this option may load the data</span>
<span class="sd">            payload of coordinate variables into memory if they are not already</span>
<span class="sd">            loaded.</span>
<span class="sd">          * &#39;all&#39;: All coordinate variables will be concatenated, except</span>
<span class="sd">            those corresponding to other dimensions.</span>
<span class="sd">          * list of str: The listed coordinate variables will be concatenated,</span>
<span class="sd">            in addition the &#39;minimal&#39; coordinates.</span>
<span class="sd">    compat : {&#39;equals&#39;, &#39;identical&#39;}, optional</span>
<span class="sd">        String indicating how to compare non-concatenated variables and</span>
<span class="sd">        dataset global attributes for potential conflicts. &#39;equals&#39; means</span>
<span class="sd">        that all variable values and dimensions must be the same;</span>
<span class="sd">        &#39;identical&#39; means that variable attributes and global attributes</span>
<span class="sd">        must also be equal.</span>
<span class="sd">    positions : None or list of integer arrays, optional</span>
<span class="sd">        List of integer arrays which specifies the integer positions to which</span>
<span class="sd">        to assign each dataset along the concatenated dimension. If not</span>
<span class="sd">        supplied, objects are concatenated in the provided order.</span>
<span class="sd">    indexers, mode, concat_over : deprecated</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    concatenated : type of objs</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    merge</span>
<span class="sd">    auto_combine</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: add join and ignore_index arguments copied from pandas.concat</span>
    <span class="c1"># TODO: support concatenating scalar coordinates even if the concatenated</span>
    <span class="c1"># dimension already exists</span>
    <span class="kn">from</span> <span class="nn">.dataset</span> <span class="k">import</span> <span class="n">Dataset</span>
    <span class="kn">from</span> <span class="nn">.dataarray</span> <span class="k">import</span> <span class="n">DataArray</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">first_obj</span><span class="p">,</span> <span class="n">objs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">peek_at</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must supply at least one object to concatenate&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;the `dim` argument to `concat` will be required &#39;</span>
                      <span class="s1">&#39;in a future version of xarray; for now, setting it to &#39;</span>
                      <span class="s2">&quot;the old default of &#39;concat_dim&#39;&quot;</span><span class="p">,</span>
                      <span class="ne">FutureWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;concat_dims&#39;</span>

    <span class="k">if</span> <span class="n">indexers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;indexers has been renamed to positions; the alias &#39;</span>
                      <span class="s1">&#39;will be removed in a future version of xarray&#39;</span><span class="p">,</span>
                      <span class="ne">FutureWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">indexers</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`mode` is no longer a valid argument to &#39;</span>
                         <span class="s1">&#39;xarray.concat; it has been split into the `data_vars` &#39;</span>
                         <span class="s1">&#39;and `coords` arguments&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">concat_over</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`concat_over` is no longer a valid argument to &#39;</span>
                         <span class="s1">&#39;xarray.concat; it has been split into the `data_vars` &#39;</span>
                         <span class="s1">&#39;and `coords` arguments&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_obj</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">_dataarray_concat</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_obj</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">_dataset_concat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;can only concatenate xarray Dataset and DataArray &#39;</span>
                        <span class="s1">&#39;objects, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">first_obj</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">objs</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">compat</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_calc_concat_dim_coord</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Infer the dimension name and 1d coordinate variable (if appropriate)</span>
<span class="sd">    for concatenating along the new dimension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;dims&#39;</span><span class="p">):</span>
        <span class="c1"># dim is not a DataArray or IndexVariable</span>
        <span class="n">dim_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dim_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dim_name</span> <span class="o">=</span> <span class="s1">&#39;concat_dim&#39;</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">IndexVariable</span><span class="p">(</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">dim_name</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">as_variable</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">to_index_variable</span><span class="p">()</span>
        <span class="n">dim</span><span class="p">,</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">dims</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="n">dim</span><span class="p">,</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">dims</span>
    <span class="k">return</span> <span class="n">dim</span><span class="p">,</span> <span class="n">coord</span>


<span class="k">def</span> <span class="nf">_calc_concat_over</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine which dataset variables need to be concatenated in the result,</span>
<span class="sd">    and which can simply be taken from the first dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">process_subset_opt</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">subset</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;coords&#39;</span><span class="p">:</span>
            <span class="n">subset_long_name</span> <span class="o">=</span> <span class="s1">&#39;coordinates&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subset_long_name</span> <span class="o">=</span> <span class="s1">&#39;data variables&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;different&#39;</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">differs</span><span class="p">(</span><span class="n">vname</span><span class="p">):</span>
                    <span class="c1"># simple helper function which compares a variable</span>
                    <span class="c1"># across all datasets and indicates whether that</span>
                    <span class="c1"># variable differs or not.</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
                    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="c1"># all nonindexes that are not the same in each dataset</span>
                <span class="n">concat_new</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">subset</span><span class="p">)</span>
                                 <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">concat_over</span> <span class="ow">and</span> <span class="n">differs</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">concat_new</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">subset</span><span class="p">))</span> <span class="o">-</span>
                              <span class="nb">set</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;minimal&#39;</span><span class="p">:</span>
                <span class="n">concat_new</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unexpected value for concat_</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">opt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">invalid_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">opt</span>
                            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">subset</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">invalid_vars</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;some variables in </span><span class="si">%s</span><span class="s1"> are not &#39;</span>
                                 <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> on the first dataset: </span><span class="si">%s</span><span class="s1">&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">subset_long_name</span><span class="p">,</span> <span class="n">invalid_vars</span><span class="p">))</span>
            <span class="n">concat_new</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">concat_new</span>

    <span class="n">concat_over</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="n">concat_over</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">concat_over</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process_subset_opt</span><span class="p">(</span><span class="n">data_vars</span><span class="p">,</span> <span class="s1">&#39;data_vars&#39;</span><span class="p">))</span>
    <span class="n">concat_over</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process_subset_opt</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">concat_over</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">concat_over</span>


<span class="k">def</span> <span class="nf">_dataset_concat</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">compat</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate a sequence of datasets along a new or existing dimension</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.dataset</span> <span class="k">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">as_dataset</span>

    <span class="k">if</span> <span class="n">compat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;equals&#39;</span><span class="p">,</span> <span class="s1">&#39;identical&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;compat=</span><span class="si">%r</span><span class="s2"> invalid: must be &#39;equals&#39; &quot;</span>
                         <span class="s2">&quot;or &#39;identical&#39;&quot;</span> <span class="o">%</span> <span class="n">compat</span><span class="p">)</span>

    <span class="n">dim</span><span class="p">,</span> <span class="n">coord</span> <span class="o">=</span> <span class="n">_calc_concat_dim_coord</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">as_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="o">*</span><span class="n">datasets</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>

    <span class="n">concat_over</span> <span class="o">=</span> <span class="n">_calc_concat_over</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert_result_variable</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="n">result_coord_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">result_vars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># create the new dataset and add constant variables</span>
    <span class="n">result_vars</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">result_coord_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
    <span class="n">result_attrs</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">concat_over</span><span class="p">:</span>
            <span class="n">insert_result_variable</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="c1"># check that global attributes and non-concatenated variables are fixed</span>
    <span class="c1"># across all datasets</span>
    <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">compat</span> <span class="o">==</span> <span class="s1">&#39;identical&#39;</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">dict_equiv</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">result_attrs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dataset global attributes not equal&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result_vars</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">concat_over</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;encountered unexpected variable </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">result_coord_names</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> is a coordinate in some datasets but not &#39;</span>
                                 <span class="s1">&#39;others&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">result_vars</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">dim</span> <span class="ow">and</span>
                  <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">compat</span><span class="p">)(</span><span class="n">result_vars</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
                <span class="n">verb</span> <span class="o">=</span> <span class="s1">&#39;equal&#39;</span> <span class="k">if</span> <span class="n">compat</span> <span class="o">==</span> <span class="s1">&#39;equals&#39;</span> <span class="k">else</span> <span class="n">compat</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;variable </span><span class="si">%r</span><span class="s1"> not </span><span class="si">%s</span><span class="s1"> across datasets&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">verb</span><span class="p">))</span>

    <span class="c1"># we&#39;ve already verified everything is consistent; now, calculate</span>
    <span class="c1"># shared dimension sizes so we can expand the necessary variables</span>
    <span class="n">dim_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
    <span class="n">non_concat_dims</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="n">non_concat_dims</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">non_concat_dims</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ensure_common_dims</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
        <span class="c1"># ensure each variable with the given name shares the same</span>
        <span class="c1"># dimensions and the same shape for all of them except along the</span>
        <span class="c1"># concat dimension</span>
        <span class="n">common_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">dims</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">common_dims</span><span class="p">:</span>
            <span class="n">common_dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,)</span> <span class="o">+</span> <span class="n">common_dims</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">dim_len</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="n">dim_lengths</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">dims</span> <span class="o">!=</span> <span class="n">common_dims</span><span class="p">:</span>
                <span class="n">common_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">non_concat_dims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dim_len</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">common_dims</span><span class="p">)</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">set_dims</span><span class="p">(</span><span class="n">common_dims</span><span class="p">,</span> <span class="n">common_shape</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">var</span>

    <span class="c1"># stack up each variable to fill-out the dataset (in order)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">concat_over</span><span class="p">:</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="n">ensure_common_dims</span><span class="p">([</span><span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">])</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">concat_vars</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
            <span class="n">insert_result_variable</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">combined</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">result_vars</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">result_attrs</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">result_coord_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># add concat dimension last to ensure that its in the final Dataset</span>
        <span class="n">result</span><span class="p">[</span><span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_dataarray_concat</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">compat</span><span class="p">,</span>
                      <span class="n">positions</span><span class="p">):</span>
    <span class="n">arrays</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_vars</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data_vars is not a valid argument when &#39;</span>
                         <span class="s1">&#39;concatenating DataArray objects&#39;</span><span class="p">)</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">name</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">arr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compat</span> <span class="o">==</span> <span class="s1">&#39;identical&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;array names not identical&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">_to_temp_dataset</span><span class="p">())</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">_dataset_concat</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">compat</span><span class="p">,</span>
                         <span class="n">positions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_from_temp_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_auto_concat</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds0</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ds1</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">concat_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds0</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ds0</span><span class="o">.</span><span class="n">dims</span> <span class="o">!=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">dim_tuples</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds0</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds1</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="n">concat_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dim_tuples</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concat_dims</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">concat_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">concat_dims</span>
                                  <span class="k">if</span> <span class="ow">not</span> <span class="n">ds0</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">ds1</span><span class="p">[</span><span class="n">d</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concat_dims</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;too many different dimensions to &#39;</span>
                                 <span class="s1">&#39;concatenate: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">concat_dims</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">concat_dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot infer dimension to concatenate: &#39;</span>
                                 <span class="s1">&#39;supply the ``concat_dim`` argument &#39;</span>
                                 <span class="s1">&#39;explicitly&#39;</span><span class="p">)</span>
            <span class="n">dim</span><span class="p">,</span> <span class="o">=</span> <span class="n">concat_dims</span>
        <span class="k">return</span> <span class="n">concat</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>


<span class="n">_CONCAT_DIM_DEFAULT</span> <span class="o">=</span> <span class="s1">&#39;__infer_concat_dim__&#39;</span>


<span class="k">def</span> <span class="nf">auto_combine</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span>
                 <span class="n">concat_dim</span><span class="o">=</span><span class="n">_CONCAT_DIM_DEFAULT</span><span class="p">,</span>
                 <span class="n">compat</span><span class="o">=</span><span class="s1">&#39;no_conflicts&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempt to auto-magically combine the given datasets into one.</span>

<span class="sd">    This method attempts to combine a list of datasets into a single entity by</span>
<span class="sd">    inspecting metadata and using a combination of concat and merge.</span>

<span class="sd">    It does not concatenate along more than one dimension or sort data under any</span>
<span class="sd">    circumstances. It does align coordinates, but different variables on</span>
<span class="sd">    datasets can cause it to fail under some scenarios. In complex cases, you</span>
<span class="sd">    may need to clean up your data and use ``concat``/``merge`` explicitly.</span>

<span class="sd">    ``auto_combine`` works well if you have N years of data and M data</span>
<span class="sd">    variables, and each combination of a distinct time period and set of data</span>
<span class="sd">    variables is saved its own dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datasets : sequence of xarray.Dataset</span>
<span class="sd">        Dataset objects to merge.</span>
<span class="sd">    concat_dim : str or DataArray or Index, optional</span>
<span class="sd">        Dimension along which to concatenate variables, as used by</span>
<span class="sd">        :py:func:`xarray.concat`. You only need to provide this argument if the</span>
<span class="sd">        dimension along which you want to concatenate is not a dimension in</span>
<span class="sd">        the original datasets, e.g., if you want to stack a collection of</span>
<span class="sd">        2D arrays along a third dimension.</span>
<span class="sd">        By default, xarray attempts to infer this argument by examining</span>
<span class="sd">        component files. Set ``concat_dim=None`` explicitly to disable</span>
<span class="sd">        concatenation.</span>
<span class="sd">    compat : {&#39;identical&#39;, &#39;equals&#39;, &#39;broadcast_equals&#39;,</span>
<span class="sd">              &#39;no_conflicts&#39;}, optional</span>
<span class="sd">        String indicating how to compare variables of the same name for</span>
<span class="sd">        potential conflicts:</span>

<span class="sd">        - &#39;broadcast_equals&#39;: all values must be equal when variables are</span>
<span class="sd">          broadcast against each other to ensure common dimensions.</span>
<span class="sd">        - &#39;equals&#39;: all values and dimensions must be the same.</span>
<span class="sd">        - &#39;identical&#39;: all values, dimensions and attributes must be the</span>
<span class="sd">          same.</span>
<span class="sd">        - &#39;no_conflicts&#39;: only values which are not null in both datasets</span>
<span class="sd">          must be equal. The returned dataset then contains the combination</span>
<span class="sd">          of all non-null values.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    combined : xarray.Dataset</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    concat</span>
<span class="sd">    Dataset.merge</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">toolz</span> <span class="k">import</span> <span class="n">itertoolz</span>
    <span class="k">if</span> <span class="n">concat_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">concat_dim</span> <span class="ow">is</span> <span class="n">_CONCAT_DIM_DEFAULT</span> <span class="k">else</span> <span class="n">concat_dim</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">itertoolz</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)),</span>
                                    <span class="n">datasets</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">concatenated</span> <span class="o">=</span> <span class="p">[</span><span class="n">_auto_concat</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">concatenated</span> <span class="o">=</span> <span class="n">datasets</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">concatenated</span><span class="p">,</span> <span class="n">compat</span><span class="o">=</span><span class="n">compat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, DESHIMA Software Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>